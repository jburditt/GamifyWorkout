import { Subject, BehaviorSubject, Subscription, of, tap, delay, filter, timer, debounce, switchMap, finalize, takeUntil, combineLatest, EMPTY } from 'rxjs';
export class NgProgressRef {
    // Get current progress state
    get snapshot() {
        return this._state.value;
    }
    // Check if progress has started
    get isStarted() {
        return this.snapshot.active;
    }
    constructor(customConfig, _onDestroyCallback) {
        this._onDestroyCallback = _onDestroyCallback;
        // Progress start source event (used to cancel finalizing delays)
        this._started = new Subject();
        // Progress start event: stream that emits only when it hasn't already started
        this.started = this._started.pipe(filter(() => !this.isStarted));
        // Progress ended source event
        this._completed = new Subject();
        // Progress start event: stream that emits only when it has already started
        this.completed = this._completed.pipe(filter(() => this.isStarted));
        // Stream that increments and updates the progress state
        this._trickling = new Subject();
        // Stream that combines "_trickling" and "config" streams
        this._worker = Subscription.EMPTY;
        this._state = new BehaviorSubject({ active: false, value: 0 });
        this._config = new BehaviorSubject(customConfig);
        this.state = this._state.asObservable();
        this.config = this._config.asObservable();
        this._worker = combineLatest([this._trickling, this._config]).pipe(debounce(([start, config]) => timer(start ? config.debounceTime : 0)), switchMap(([start, config]) => start ? this.onTrickling(config) : this.onComplete(config))).subscribe();
    }
    /**
     * Start the progress
     */
    start() {
        this._started.next();
        this._trickling.next(true);
    }
    /**
     * Complete the progress
     */
    complete() {
        this._trickling.next(false);
    }
    /**
     * Increment the progress
     */
    inc(amount) {
        const n = this.snapshot.value;
        if (!this.isStarted) {
            this.start();
        }
        else {
            if (typeof amount !== 'number') {
                amount = this._config.value.trickleFunc(n);
            }
            this.set(n + amount);
        }
    }
    /**
     * Set the progress
     */
    set(n) {
        this.setState({ value: this.clamp(n), active: true });
    }
    /**
     * Set config
     */
    setConfig(config) {
        this._config.next({ ...this._config.value, ...config });
    }
    /**
     * Destroy progress reference
     */
    destroy() {
        this._worker.unsubscribe();
        this._trickling.complete();
        this._state.complete();
        this._config.complete();
        this._started.complete();
        this._completed.complete();
        this._onDestroyCallback();
    }
    /**
     * Set progress state
     */
    setState(state) {
        this._state.next({ ...this.snapshot, ...state });
    }
    /**
     * Clamps a value to be between min and max
     */
    clamp(n) {
        return Math.max(this._config.value.min, Math.min(this._config.value.max, n));
    }
    /**
     * Keeps incrementing the progress
     */
    onTrickling(config) {
        if (!this.isStarted) {
            this.set(this._config.value.min);
        }
        return timer(0, config.trickleSpeed).pipe(tap(() => this.inc()));
    }
    /**
     * Completes then resets the progress
     */
    onComplete(config) {
        this._completed.next();
        return !this.isStarted ? EMPTY : of({}).pipe(
        // Complete the progress
        tap(() => this.setState({ value: 100 })), 
        // Deactivate the progress after a tiny delay
        delay(config.speed * 1.7), tap(() => this.setState({ active: false })), 
        // Use a tiny delay before resetting
        delay(config.speed), 
        // Force the progress to reset even it got cancelled
        finalize(() => this.setState({ value: 0 })), 
        // Cancel any of the finalizing delays if the progress has started again
        takeUntil(this._started));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcHJvZ3Jlc3MtcmVmLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXByb2dyZXNzYmFyL3NyYy9saWIvbmctcHJvZ3Jlc3MtcmVmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxPQUFPLEVBQ1AsZUFBZSxFQUNmLFlBQVksRUFDWixFQUFFLEVBQ0YsR0FBRyxFQUNILEtBQUssRUFDTCxNQUFNLEVBQ04sS0FBSyxFQUNMLFFBQVEsRUFDUixTQUFTLEVBQ1QsUUFBUSxFQUNSLFNBQVMsRUFDVCxhQUFhLEVBQ2IsS0FBSyxFQUNOLE1BQU0sTUFBTSxDQUFDO0FBR2QsTUFBTSxPQUFPLGFBQWE7SUEwQnhCLDZCQUE2QjtJQUM3QixJQUFZLFFBQVE7UUFDbEIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztJQUMzQixDQUFDO0lBRUQsZ0NBQWdDO0lBQ2hDLElBQUksU0FBUztRQUNYLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7SUFDOUIsQ0FBQztJQUVELFlBQVksWUFBNEIsRUFBVSxrQkFBOEI7UUFBOUIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFZO1FBMUJoRixpRUFBaUU7UUFDaEQsYUFBUSxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDaEQsOEVBQThFO1FBQ3JFLFlBQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUVyRSw4QkFBOEI7UUFDYixlQUFVLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUNsRCwyRUFBMkU7UUFDbEUsY0FBUyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUV4RSx3REFBd0Q7UUFDdkMsZUFBVSxHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFFckQseURBQXlEO1FBQ3hDLFlBQU8sR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO1FBYTVDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxlQUFlLENBQWdCLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM5RSxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksZUFBZSxDQUFpQixZQUFZLENBQUMsQ0FBQztRQUNqRSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDeEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRTFDLElBQUksQ0FBQyxPQUFPLEdBQUcsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQ2hFLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBNEIsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFDaEcsU0FBUyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUE0QixFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FDdEgsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLO1FBQ0gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxRQUFRO1FBQ04sSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsR0FBRyxDQUFDLE1BQWU7UUFDakIsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7UUFDOUIsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbkIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ2Q7YUFBTTtZQUNMLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFO2dCQUM5QixNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzVDO1lBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUM7U0FDdEI7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxHQUFHLENBQUMsQ0FBUztRQUNYLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTLENBQUMsTUFBd0I7UUFDaEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQUFPO1FBQ0wsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUMzQixJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssUUFBUSxDQUFDLEtBQXNCO1FBQ3JDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxLQUFLLENBQUMsQ0FBUztRQUNyQixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDL0UsQ0FBQztJQUVEOztPQUVHO0lBQ0ssV0FBVyxDQUFDLE1BQXNCO1FBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ25CLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDbEM7UUFDRCxPQUFPLEtBQUssQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRUQ7O09BRUc7SUFDSyxVQUFVLENBQUMsTUFBc0I7UUFDdkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN2QixPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSTtRQUMxQyx3QkFBd0I7UUFDeEIsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUV4Qyw2Q0FBNkM7UUFDN0MsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLEVBQ3pCLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFFM0Msb0NBQW9DO1FBQ3BDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ25CLG9EQUFvRDtRQUNwRCxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLHdFQUF3RTtRQUN4RSxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUN6QixDQUFDO0lBQ0osQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBPYnNlcnZhYmxlLFxyXG4gIFN1YmplY3QsXHJcbiAgQmVoYXZpb3JTdWJqZWN0LFxyXG4gIFN1YnNjcmlwdGlvbixcclxuICBvZixcclxuICB0YXAsXHJcbiAgZGVsYXksXHJcbiAgZmlsdGVyLFxyXG4gIHRpbWVyLFxyXG4gIGRlYm91bmNlLFxyXG4gIHN3aXRjaE1hcCxcclxuICBmaW5hbGl6ZSxcclxuICB0YWtlVW50aWwsXHJcbiAgY29tYmluZUxhdGVzdCxcclxuICBFTVBUWVxyXG59IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBOZ1Byb2dyZXNzU3RhdGUsIE5nUHJvZ3Jlc3NDb25maWcsIFByb2dyZXNzQ29uZmlnLCBQcm9ncmVzc1N0YXRlIH0gZnJvbSAnLi9uZy1wcm9ncmVzcy5pbnRlcmZhY2UnO1xyXG5cclxuZXhwb3J0IGNsYXNzIE5nUHJvZ3Jlc3NSZWYge1xyXG5cclxuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHByb2dyZXNzIHN0YXRlIGlzIGNoYW5nZWRcclxuICBwcml2YXRlIHJlYWRvbmx5IF9zdGF0ZTogQmVoYXZpb3JTdWJqZWN0PFByb2dyZXNzU3RhdGU+O1xyXG4gIHN0YXRlOiBPYnNlcnZhYmxlPFByb2dyZXNzU3RhdGU+O1xyXG5cclxuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIGNvbmZpZyBpcyBjaGFuZ2VkXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfY29uZmlnOiBCZWhhdmlvclN1YmplY3Q8UHJvZ3Jlc3NDb25maWc+O1xyXG4gIGNvbmZpZzogT2JzZXJ2YWJsZTxQcm9ncmVzc0NvbmZpZz47XHJcblxyXG4gIC8vIFByb2dyZXNzIHN0YXJ0IHNvdXJjZSBldmVudCAodXNlZCB0byBjYW5jZWwgZmluYWxpemluZyBkZWxheXMpXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfc3RhcnRlZCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XHJcbiAgLy8gUHJvZ3Jlc3Mgc3RhcnQgZXZlbnQ6IHN0cmVhbSB0aGF0IGVtaXRzIG9ubHkgd2hlbiBpdCBoYXNuJ3QgYWxyZWFkeSBzdGFydGVkXHJcbiAgcmVhZG9ubHkgc3RhcnRlZCA9IHRoaXMuX3N0YXJ0ZWQucGlwZShmaWx0ZXIoKCkgPT4gIXRoaXMuaXNTdGFydGVkKSk7XHJcblxyXG4gIC8vIFByb2dyZXNzIGVuZGVkIHNvdXJjZSBldmVudFxyXG4gIHByaXZhdGUgcmVhZG9ubHkgX2NvbXBsZXRlZCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XHJcbiAgLy8gUHJvZ3Jlc3Mgc3RhcnQgZXZlbnQ6IHN0cmVhbSB0aGF0IGVtaXRzIG9ubHkgd2hlbiBpdCBoYXMgYWxyZWFkeSBzdGFydGVkXHJcbiAgcmVhZG9ubHkgY29tcGxldGVkID0gdGhpcy5fY29tcGxldGVkLnBpcGUoZmlsdGVyKCgpID0+IHRoaXMuaXNTdGFydGVkKSk7XHJcblxyXG4gIC8vIFN0cmVhbSB0aGF0IGluY3JlbWVudHMgYW5kIHVwZGF0ZXMgdGhlIHByb2dyZXNzIHN0YXRlXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfdHJpY2tsaW5nID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcclxuXHJcbiAgLy8gU3RyZWFtIHRoYXQgY29tYmluZXMgXCJfdHJpY2tsaW5nXCIgYW5kIFwiY29uZmlnXCIgc3RyZWFtc1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgX3dvcmtlciA9IFN1YnNjcmlwdGlvbi5FTVBUWTtcclxuXHJcbiAgLy8gR2V0IGN1cnJlbnQgcHJvZ3Jlc3Mgc3RhdGVcclxuICBwcml2YXRlIGdldCBzbmFwc2hvdCgpOiBQcm9ncmVzc1N0YXRlIHtcclxuICAgIHJldHVybiB0aGlzLl9zdGF0ZS52YWx1ZTtcclxuICB9XHJcblxyXG4gIC8vIENoZWNrIGlmIHByb2dyZXNzIGhhcyBzdGFydGVkXHJcbiAgZ2V0IGlzU3RhcnRlZCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLnNuYXBzaG90LmFjdGl2ZTtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKGN1c3RvbUNvbmZpZzogUHJvZ3Jlc3NDb25maWcsIHByaXZhdGUgX29uRGVzdHJveUNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XHJcbiAgICB0aGlzLl9zdGF0ZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8UHJvZ3Jlc3NTdGF0ZT4oeyBhY3RpdmU6IGZhbHNlLCB2YWx1ZTogMCB9KTtcclxuICAgIHRoaXMuX2NvbmZpZyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8UHJvZ3Jlc3NDb25maWc+KGN1c3RvbUNvbmZpZyk7XHJcbiAgICB0aGlzLnN0YXRlID0gdGhpcy5fc3RhdGUuYXNPYnNlcnZhYmxlKCk7XHJcbiAgICB0aGlzLmNvbmZpZyA9IHRoaXMuX2NvbmZpZy5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgICB0aGlzLl93b3JrZXIgPSBjb21iaW5lTGF0ZXN0KFt0aGlzLl90cmlja2xpbmcsIHRoaXMuX2NvbmZpZ10pLnBpcGUoXHJcbiAgICAgIGRlYm91bmNlKChbc3RhcnQsIGNvbmZpZ106IFtib29sZWFuLCBQcm9ncmVzc0NvbmZpZ10pID0+IHRpbWVyKHN0YXJ0ID8gY29uZmlnLmRlYm91bmNlVGltZSA6IDApKSxcclxuICAgICAgc3dpdGNoTWFwKChbc3RhcnQsIGNvbmZpZ106IFtib29sZWFuLCBQcm9ncmVzc0NvbmZpZ10pID0+IHN0YXJ0ID8gdGhpcy5vblRyaWNrbGluZyhjb25maWcpIDogdGhpcy5vbkNvbXBsZXRlKGNvbmZpZykpXHJcbiAgICApLnN1YnNjcmliZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3RhcnQgdGhlIHByb2dyZXNzXHJcbiAgICovXHJcbiAgc3RhcnQoKSB7XHJcbiAgICB0aGlzLl9zdGFydGVkLm5leHQoKTtcclxuICAgIHRoaXMuX3RyaWNrbGluZy5uZXh0KHRydWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29tcGxldGUgdGhlIHByb2dyZXNzXHJcbiAgICovXHJcbiAgY29tcGxldGUoKSB7XHJcbiAgICB0aGlzLl90cmlja2xpbmcubmV4dChmYWxzZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBJbmNyZW1lbnQgdGhlIHByb2dyZXNzXHJcbiAgICovXHJcbiAgaW5jKGFtb3VudD86IG51bWJlcikge1xyXG4gICAgY29uc3QgbiA9IHRoaXMuc25hcHNob3QudmFsdWU7XHJcbiAgICBpZiAoIXRoaXMuaXNTdGFydGVkKSB7XHJcbiAgICAgIHRoaXMuc3RhcnQoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmICh0eXBlb2YgYW1vdW50ICE9PSAnbnVtYmVyJykge1xyXG4gICAgICAgIGFtb3VudCA9IHRoaXMuX2NvbmZpZy52YWx1ZS50cmlja2xlRnVuYyhuKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnNldChuICsgYW1vdW50KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldCB0aGUgcHJvZ3Jlc3NcclxuICAgKi9cclxuICBzZXQobjogbnVtYmVyKSB7XHJcbiAgICB0aGlzLnNldFN0YXRlKHsgdmFsdWU6IHRoaXMuY2xhbXAobiksIGFjdGl2ZTogdHJ1ZSB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldCBjb25maWdcclxuICAgKi9cclxuICBzZXRDb25maWcoY29uZmlnOiBOZ1Byb2dyZXNzQ29uZmlnKSB7XHJcbiAgICB0aGlzLl9jb25maWcubmV4dCh7IC4uLnRoaXMuX2NvbmZpZy52YWx1ZSwgLi4uY29uZmlnIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRGVzdHJveSBwcm9ncmVzcyByZWZlcmVuY2VcclxuICAgKi9cclxuICBkZXN0cm95KCkge1xyXG4gICAgdGhpcy5fd29ya2VyLnVuc3Vic2NyaWJlKCk7XHJcbiAgICB0aGlzLl90cmlja2xpbmcuY29tcGxldGUoKTtcclxuICAgIHRoaXMuX3N0YXRlLmNvbXBsZXRlKCk7XHJcbiAgICB0aGlzLl9jb25maWcuY29tcGxldGUoKTtcclxuICAgIHRoaXMuX3N0YXJ0ZWQuY29tcGxldGUoKTtcclxuICAgIHRoaXMuX2NvbXBsZXRlZC5jb21wbGV0ZSgpO1xyXG4gICAgdGhpcy5fb25EZXN0cm95Q2FsbGJhY2soKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldCBwcm9ncmVzcyBzdGF0ZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0U3RhdGUoc3RhdGU6IE5nUHJvZ3Jlc3NTdGF0ZSkge1xyXG4gICAgdGhpcy5fc3RhdGUubmV4dCh7IC4uLnRoaXMuc25hcHNob3QsIC4uLnN0YXRlIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2xhbXBzIGEgdmFsdWUgdG8gYmUgYmV0d2VlbiBtaW4gYW5kIG1heFxyXG4gICAqL1xyXG4gIHByaXZhdGUgY2xhbXAobjogbnVtYmVyKTogbnVtYmVyIHtcclxuICAgIHJldHVybiBNYXRoLm1heCh0aGlzLl9jb25maWcudmFsdWUubWluLCBNYXRoLm1pbih0aGlzLl9jb25maWcudmFsdWUubWF4LCBuKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBLZWVwcyBpbmNyZW1lbnRpbmcgdGhlIHByb2dyZXNzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBvblRyaWNrbGluZyhjb25maWc6IFByb2dyZXNzQ29uZmlnKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcclxuICAgIGlmICghdGhpcy5pc1N0YXJ0ZWQpIHtcclxuICAgICAgdGhpcy5zZXQodGhpcy5fY29uZmlnLnZhbHVlLm1pbik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGltZXIoMCwgY29uZmlnLnRyaWNrbGVTcGVlZCkucGlwZSh0YXAoKCkgPT4gdGhpcy5pbmMoKSkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29tcGxldGVzIHRoZW4gcmVzZXRzIHRoZSBwcm9ncmVzc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgb25Db21wbGV0ZShjb25maWc6IFByb2dyZXNzQ29uZmlnKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHRoaXMuX2NvbXBsZXRlZC5uZXh0KCk7XHJcbiAgICByZXR1cm4gIXRoaXMuaXNTdGFydGVkID8gRU1QVFkgOiBvZih7fSkucGlwZShcclxuICAgICAgLy8gQ29tcGxldGUgdGhlIHByb2dyZXNzXHJcbiAgICAgIHRhcCgoKSA9PiB0aGlzLnNldFN0YXRlKHsgdmFsdWU6IDEwMCB9KSksXHJcblxyXG4gICAgICAvLyBEZWFjdGl2YXRlIHRoZSBwcm9ncmVzcyBhZnRlciBhIHRpbnkgZGVsYXlcclxuICAgICAgZGVsYXkoY29uZmlnLnNwZWVkICogMS43KSxcclxuICAgICAgdGFwKCgpID0+IHRoaXMuc2V0U3RhdGUoeyBhY3RpdmU6IGZhbHNlIH0pKSxcclxuXHJcbiAgICAgIC8vIFVzZSBhIHRpbnkgZGVsYXkgYmVmb3JlIHJlc2V0dGluZ1xyXG4gICAgICBkZWxheShjb25maWcuc3BlZWQpLFxyXG4gICAgICAvLyBGb3JjZSB0aGUgcHJvZ3Jlc3MgdG8gcmVzZXQgZXZlbiBpdCBnb3QgY2FuY2VsbGVkXHJcbiAgICAgIGZpbmFsaXplKCgpID0+IHRoaXMuc2V0U3RhdGUoeyB2YWx1ZTogMCB9KSksXHJcbiAgICAgIC8vIENhbmNlbCBhbnkgb2YgdGhlIGZpbmFsaXppbmcgZGVsYXlzIGlmIHRoZSBwcm9ncmVzcyBoYXMgc3RhcnRlZCBhZ2FpblxyXG4gICAgICB0YWtlVW50aWwodGhpcy5fc3RhcnRlZClcclxuICAgICk7XHJcbiAgfVxyXG59XHJcbiJdfQ==